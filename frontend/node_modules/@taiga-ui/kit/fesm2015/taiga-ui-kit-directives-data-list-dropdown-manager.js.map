{"version":3,"file":"taiga-ui-kit-directives-data-list-dropdown-manager.js","sources":["../../../projects/kit/directives/data-list-dropdown-manager/data-list-dropdown-manager.directive.ts","../../../projects/kit/directives/data-list-dropdown-manager/data-list-dropdown-manager.module.ts","../../../projects/kit/directives/data-list-dropdown-manager/taiga-ui-kit-directives-data-list-dropdown-manager.ts"],"sourcesContent":["import {\n    AfterViewInit,\n    ContentChildren,\n    Directive,\n    ElementRef,\n    Inject,\n    QueryList,\n    Self,\n} from '@angular/core';\nimport {\n    EMPTY_QUERY,\n    TuiDestroyService,\n    tuiGetClosestFocusable,\n    tuiPreventDefault,\n    tuiPure,\n    tuiQueryListChanges,\n    tuiTypedFromEvent,\n} from '@taiga-ui/cdk';\nimport {TuiDropdownDirective} from '@taiga-ui/core';\nimport {EMPTY, merge, Observable} from 'rxjs';\nimport {\n    debounceTime,\n    filter,\n    map,\n    shareReplay,\n    switchMap,\n    take,\n    takeUntil,\n    tap,\n} from 'rxjs/operators';\n\n@Directive({\n    selector: 'tui-data-list[tuiDataListDropdownManager]',\n    providers: [TuiDestroyService],\n})\nexport class TuiDataListDropdownManagerDirective implements AfterViewInit {\n    @ContentChildren(TuiDropdownDirective, {descendants: true})\n    private readonly dropdowns: QueryList<TuiDropdownDirective> = EMPTY_QUERY;\n\n    @ContentChildren(TuiDropdownDirective, {read: ElementRef, descendants: true})\n    private readonly els: QueryList<ElementRef<HTMLElement>> = EMPTY_QUERY;\n\n    constructor(\n        @Self() @Inject(TuiDestroyService) private readonly destroy$: TuiDestroyService,\n    ) {}\n\n    ngAfterViewInit(): void {\n        this.right$.pipe(takeUntil(this.destroy$)).subscribe(index => {\n            this.tryToFocus(index);\n        });\n\n        merge(this.immediate$, this.debounce$)\n            .pipe(\n                switchMap(active => {\n                    this.dropdowns.forEach((dropdown, index) => {\n                        dropdown.toggle(index === active);\n                    });\n\n                    const element = this.els.get(active);\n                    const dropdown = this.dropdowns.get(active);\n\n                    if (!element || !dropdown?.dropdownBoxRef) {\n                        return EMPTY;\n                    }\n\n                    const {nativeElement} = dropdown.dropdownBoxRef.location;\n                    const mouseEnter$ = tuiTypedFromEvent(\n                        nativeElement,\n                        'mouseenter',\n                    ).pipe(take(1));\n                    const esc$ = merge(\n                        tuiTypedFromEvent(element.nativeElement, 'keydown'),\n                        tuiTypedFromEvent(nativeElement, 'keydown'),\n                    ).pipe(filter(({key}) => key === 'Escape'));\n\n                    return merge(mouseEnter$, esc$).pipe(\n                        tap(event => {\n                            if (dropdown.dropdownBoxRef) {\n                                event.stopPropagation();\n                            }\n\n                            element.nativeElement.focus();\n                            dropdown.toggle('offsetX' in event);\n                        }),\n                    );\n                }),\n                takeUntil(this.destroy$),\n            )\n            .subscribe();\n    }\n\n    @tuiPure\n    private get elements$(): Observable<readonly HTMLElement[]> {\n        return tuiQueryListChanges(this.els).pipe(\n            map(array => array.map(({nativeElement}) => nativeElement)),\n            shareReplay({bufferSize: 1, refCount: true}),\n        );\n    }\n\n    @tuiPure\n    private get right$(): Observable<number> {\n        return this.elements$.pipe(\n            switchMap(elements =>\n                merge(\n                    ...elements.map((element, index) =>\n                        tuiTypedFromEvent(element, 'keydown').pipe(\n                            filter(({key}) => key === 'ArrowRight'),\n                            tuiPreventDefault(),\n                            map(() => index),\n                        ),\n                    ),\n                ),\n            ),\n        );\n    }\n\n    @tuiPure\n    private get immediate$(): Observable<number> {\n        return this.elements$.pipe(\n            switchMap(elements =>\n                merge(\n                    ...elements.map((element, index) =>\n                        tuiTypedFromEvent(element, 'click').pipe(map(() => index)),\n                    ),\n                ),\n            ),\n        );\n    }\n\n    @tuiPure\n    private get debounce$(): Observable<number> {\n        return this.elements$.pipe(\n            switchMap(elements =>\n                merge(\n                    ...elements.map((element, index) =>\n                        merge(\n                            tuiTypedFromEvent(element, 'focus'),\n                            tuiTypedFromEvent(element, 'blur'),\n                        ).pipe(\n                            filter(({relatedTarget}) =>\n                                this.notInDropdown(relatedTarget, index),\n                            ),\n                            map(({type}) => (type === 'focus' ? index : NaN)),\n                        ),\n                    ),\n                ),\n            ),\n            debounceTime(300),\n        );\n    }\n\n    private notInDropdown(element: EventTarget | null, index: number): boolean {\n        return !this.dropdowns\n            .get(index)\n            ?.dropdownBoxRef?.location.nativeElement.contains(element);\n    }\n\n    private tryToFocus(index: number): void {\n        const content = this.dropdowns.get(index)?.dropdownBoxRef?.location.nativeElement;\n\n        if (!content) {\n            return;\n        }\n\n        // First item is focus trap\n        const focusTrap = tuiGetClosestFocusable({initial: content, root: content});\n        const item = tuiGetClosestFocusable({\n            initial: focusTrap || content,\n            root: content,\n        });\n\n        if (item) {\n            item.focus();\n        }\n    }\n}\n","import {NgModule} from '@angular/core';\n\nimport {TuiDataListDropdownManagerDirective} from './data-list-dropdown-manager.directive';\n\n@NgModule({\n    declarations: [TuiDataListDropdownManagerDirective],\n    exports: [TuiDataListDropdownManagerDirective],\n})\nexport class TuiDataListDropdownManagerModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}