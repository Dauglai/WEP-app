import { CHAR_HYPHEN, CHAR_NO_BREAK_SPACE, tuiAssert, tuiGetDocumentOrShadowRoot, tuiIsNativeFocused, tuiIsSafari, } from '@taiga-ui/cdk';
/**
 * Used to finish a number with zeros to a given precision
 */
export function tuiCreateAutoCorrectedNumberPipe(decimalLimit = 0, decimalSymbol = `,`, thousandSymbol = CHAR_NO_BREAK_SPACE, nativeInput, allowNegative, isIOS = false) {
    ngDevMode && tuiAssert.assert(decimalLimit >= 0);
    // Guess for which browser I need this :)
    let previousCaret = -1;
    const unlucky = (!!nativeInput && tuiIsSafari(nativeInput)) || isIOS;
    if (nativeInput && unlucky) {
        nativeInput.addEventListener(`beforeinput`, () => {
            previousCaret = nativeInput.selectionStart || 0;
        });
    }
    return (conformedValue, config) => {
        // Removing everything by selecting and pressing '-'
        if (!conformedValue && config.rawValue === CHAR_HYPHEN && allowNegative) {
            return CHAR_HYPHEN;
        }
        // remove these hacks after text mask library has changed
        if (nativeInput && unlucky && tuiIsNativeFocused(nativeInput)) {
            const caret = calculateSafariCaret(config.previousConformedValue, conformedValue, previousCaret);
            setTimeout(() => {
                nativeInput.setSelectionRange(caret, caret);
            });
        }
        if (nativeInput &&
            nativeInput.ownerDocument !== tuiGetDocumentOrShadowRoot(nativeInput) &&
            tuiIsNativeFocused(nativeInput) &&
            config.currentCaretPosition) {
            const realCaretPosition = config.currentCaretPosition +
                calculateCaretGap(config.previousConformedValue, conformedValue, thousandSymbol);
            setTimeout(() => {
                nativeInput.setSelectionRange(realCaretPosition, realCaretPosition);
            });
        }
        if (conformedValue === `` || !decimalLimit || !Number.isInteger(decimalLimit)) {
            return { value: conformedValue };
        }
        const withDecimalSymbol = addDecimalSymbolIfNeeded(conformedValue, decimalSymbol);
        const decimalPart = withDecimalSymbol.split(decimalSymbol)[1];
        const zeroPaddingSize = decimalLimit - decimalPart.length;
        return {
            value: withDecimalSymbol + `0`.repeat(zeroPaddingSize),
        };
    };
}
function addDecimalSymbolIfNeeded(value, decimalSymbol = `,`) {
    return !value.includes(decimalSymbol) ? value + decimalSymbol : value;
}
function calculateSafariCaret(previousValue = ``, current, previousCaret, decimalSymbol = `,`) {
    const tailRegex = new RegExp(`${decimalSymbol}.+`);
    const previousWithoutTail = previousValue.replace(tailRegex, ``);
    const currentWithoutTail = current.replace(tailRegex, ``);
    const pasteOrCutOperation = Math.abs(previousWithoutTail.length - currentWithoutTail.length) > 2;
    if (pasteOrCutOperation) {
        return current.length;
    }
    if (previousValue.length === current.length) {
        if (previousValue.indexOf(decimalSymbol) <= previousCaret) {
            return calculateChangedTailIndex(previousValue, current);
        }
        return previousWithoutTail === currentWithoutTail
            ? previousCaret - 1
            : previousCaret + 1;
    }
    if (previousValue.length === 0) {
        return 1;
    }
    const changeLength = current.length - previousValue.length;
    return previousCaret + changeLength;
}
function calculateChangedTailIndex(previous, current) {
    for (let i = 0; i < current.length; i++) {
        if (previous[i] !== current[i]) {
            return current[i] === `0` ? i : i + 1;
        }
    }
    return current.length;
}
function calculateCaretGap(previousValue = ``, current, thousandSymbol) {
    const pasteOrCutOperation = Math.abs(previousValue.length - current.length) > 2;
    if (pasteOrCutOperation) {
        return 0;
    }
    const wereSpaces = previousValue.split(thousandSymbol).length;
    const nowSpaces = current.split(thousandSymbol).length;
    return nowSpaces - wereSpaces;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWF1dG8tY29ycmVjdGVkLW1vbmV5LXBpcGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jb3JlL3V0aWxzL21hc2svY3JlYXRlLWF1dG8tY29ycmVjdGVkLW1vbmV5LXBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILFdBQVcsRUFDWCxtQkFBbUIsRUFDbkIsU0FBUyxFQUNULDBCQUEwQixFQUMxQixrQkFBa0IsRUFDbEIsV0FBVyxHQUNkLE1BQU0sZUFBZSxDQUFDO0FBSXZCOztHQUVHO0FBQ0gsTUFBTSxVQUFVLGdDQUFnQyxDQUM1QyxlQUF1QixDQUFDLEVBQ3hCLGdCQUFrQyxHQUFHLEVBQ3JDLGlCQUF5QixtQkFBbUIsRUFDNUMsV0FBcUMsRUFDckMsYUFBdUIsRUFDdkIsS0FBSyxHQUFHLEtBQUs7SUFFYixTQUFTLElBQUksU0FBUyxDQUFDLE1BQU0sQ0FBQyxZQUFZLElBQUksQ0FBQyxDQUFDLENBQUM7SUFFakQseUNBQXlDO0lBQ3pDLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3ZCLE1BQU0sT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLFdBQVcsSUFBSSxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUM7SUFFckUsSUFBSSxXQUFXLElBQUksT0FBTyxFQUFFO1FBQ3hCLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO1lBQzdDLGFBQWEsR0FBRyxXQUFXLENBQUMsY0FBYyxJQUFJLENBQUMsQ0FBQztRQUNwRCxDQUFDLENBQUMsQ0FBQztLQUNOO0lBRUQsT0FBTyxDQUFDLGNBQWMsRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUM5QixvREFBb0Q7UUFDcEQsSUFBSSxDQUFDLGNBQWMsSUFBSSxNQUFNLENBQUMsUUFBUSxLQUFLLFdBQVcsSUFBSSxhQUFhLEVBQUU7WUFDckUsT0FBTyxXQUFX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QU0sQ0FBQztJQUV2RCxPQUFPLFNBQVMsR0FBRyxVQUFVLENBQUM7QUFDbEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgQ0hBUl9IWVBIRU4sXG4gICAgQ0hBUl9OT19CUkVBS19TUEFDRSxcbiAgICB0dWlBc3NlcnQsXG4gICAgdHVpR2V0RG9jdW1lbnRPclNoYWRvd1Jvb3QsXG4gICAgdHVpSXNOYXRpdmVGb2N1c2VkLFxuICAgIHR1aUlzU2FmYXJpLFxufSBmcm9tICdAdGFpZ2EtdWkvY2RrJztcbmltcG9ydCB7VHVpVGV4dE1hc2tQaXBlSGFuZGxlcn0gZnJvbSAnQHRhaWdhLXVpL2NvcmUvbWFzayc7XG5pbXBvcnQge1R1aURlY2ltYWxTeW1ib2x9IGZyb20gJ0B0YWlnYS11aS9jb3JlL3R5cGVzJztcblxuLyoqXG4gKiBVc2VkIHRvIGZpbmlzaCBhIG51bWJlciB3aXRoIHplcm9zIHRvIGEgZ2l2ZW4gcHJlY2lzaW9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0dWlDcmVhdGVBdXRvQ29ycmVjdGVkTnVtYmVyUGlwZShcbiAgICBkZWNpbWFsTGltaXQ6IG51bWJlciA9IDAsXG4gICAgZGVjaW1hbFN5bWJvbDogVHVpRGVjaW1hbFN5bWJvbCA9IGAsYCxcbiAgICB0aG91c2FuZFN5bWJvbDogc3RyaW5nID0gQ0hBUl9OT19CUkVBS19TUEFDRSxcbiAgICBuYXRpdmVJbnB1dD86IEhUTUxJbnB1dEVsZW1lbnQgfCBudWxsLFxuICAgIGFsbG93TmVnYXRpdmU/OiBib29sZWFuLFxuICAgIGlzSU9TID0gZmFsc2UsXG4pOiBUdWlUZXh0TWFza1BpcGVIYW5kbGVyIHtcbiAgICBuZ0Rldk1vZGUgJiYgdHVpQXNzZXJ0LmFzc2VydChkZWNpbWFsTGltaXQgPj0gMCk7XG5cbiAgICAvLyBHdWVzcyBmb3Igd2hpY2ggYnJvd3NlciBJIG5lZWQgdGhpcyA6KVxuICAgIGxldCBwcmV2aW91c0NhcmV0ID0gLTE7XG4gICAgY29uc3QgdW5sdWNreSA9ICghIW5hdGl2ZUlucHV0ICYmIHR1aUlzU2FmYXJpKG5hdGl2ZUlucHV0KSkgfHwgaXNJT1M7XG5cbiAgICBpZiAobmF0aXZlSW5wdXQgJiYgdW5sdWNreSkge1xuICAgICAgICBuYXRpdmVJbnB1dC5hZGRFdmVudExpc3RlbmVyKGBiZWZvcmVpbnB1dGAsICgpID0+IHtcbiAgICAgICAgICAgIHByZXZpb3VzQ2FyZXQgPSBuYXRpdmVJbnB1dC5zZWxlY3Rpb25TdGFydCB8fCAwO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gKGNvbmZvcm1lZFZhbHVlLCBjb25maWcpID0+IHtcbiAgICAgICAgLy8gUmVtb3ZpbmcgZXZlcnl0aGluZyBieSBzZWxlY3RpbmcgYW5kIHByZXNzaW5nICctJ1xuICAgICAgICBpZiAoIWNvbmZvcm1lZFZhbHVlICYmIGNvbmZpZy5yYXdWYWx1ZSA9PT0gQ0hBUl9IWVBIRU4gJiYgYWxsb3dOZWdhdGl2ZSkge1xuICAgICAgICAgICAgcmV0dXJuIENIQVJfSFlQSEVOO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gcmVtb3ZlIHRoZXNlIGhhY2tzIGFmdGVyIHRleHQgbWFzayBsaWJyYXJ5IGhhcyBjaGFuZ2VkXG4gICAgICAgIGlmIChuYXRpdmVJbnB1dCAmJiB1bmx1Y2t5ICYmIHR1aUlzTmF0aXZlRm9jdXNlZChuYXRpdmVJbnB1dCkpIHtcbiAgICAgICAgICAgIGNvbnN0IGNhcmV0ID0gY2FsY3VsYXRlU2FmYXJpQ2FyZXQoXG4gICAgICAgICAgICAgICAgY29uZmlnLnByZXZpb3VzQ29uZm9ybWVkVmFsdWUsXG4gICAgICAgICAgICAgICAgY29uZm9ybWVkVmFsdWUsXG4gICAgICAgICAgICAgICAgcHJldmlvdXNDYXJldCxcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIG5hdGl2ZUlucHV0LnNldFNlbGVjdGlvblJhbmdlKGNhcmV0LCBjYXJldCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIG5hdGl2ZUlucHV0ICYmXG4gICAgICAgICAgICBuYXRpdmVJbnB1dC5vd25lckRvY3VtZW50ICE9PSB0dWlHZXREb2N1bWVudE9yU2hhZG93Um9vdChuYXRpdmVJbnB1dCkgJiZcbiAgICAgICAgICAgIHR1aUlzTmF0aXZlRm9jdXNlZChuYXRpdmVJbnB1dCkgJiZcbiAgICAgICAgICAgIGNvbmZpZy5jdXJyZW50Q2FyZXRQb3NpdGlvblxuICAgICAgICApIHtcbiAgICAgICAgICAgIGNvbnN0IHJlYWxDYXJldFBvc2l0aW9uID1cbiAgICAgICAgICAgICAgICBjb25maWcuY3VycmVudENhcmV0UG9zaXRpb24gK1xuICAgICAgICAgICAgICAgIGNhbGN1bGF0ZUNhcmV0R2FwKFxuICAgICAgICAgICAgICAgICAgICBjb25maWcucHJldmlvdXNDb25mb3JtZWRWYWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgY29uZm9ybWVkVmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIHRob3VzYW5kU3ltYm9sLFxuICAgICAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIG5hdGl2ZUlucHV0LnNldFNlbGVjdGlvblJhbmdlKHJlYWxDYXJldFBvc2l0aW9uLCByZWFsQ2FyZXRQb3NpdGlvbik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb25mb3JtZWRWYWx1ZSA9PT0gYGAgfHwgIWRlY2ltYWxMaW1pdCB8fCAhTnVtYmVyLmlzSW50ZWdlcihkZWNpbWFsTGltaXQpKSB7XG4gICAgICAgICAgICByZXR1cm4ge3ZhbHVlOiBjb25mb3JtZWRWYWx1ZX07XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB3aXRoRGVjaW1hbFN5bWJvbCA9IGFkZERlY2ltYWxTeW1ib2xJZk5lZWRlZChjb25mb3JtZWRWYWx1ZSwgZGVjaW1hbFN5bWJvbCk7XG4gICAgICAgIGNvbnN0IGRlY2ltYWxQYXJ0ID0gd2l0aERlY2ltYWxTeW1ib2wuc3BsaXQoZGVjaW1hbFN5bWJvbClbMV07XG4gICAgICAgIGNvbnN0IHplcm9QYWRkaW5nU2l6ZSA9IGRlY2ltYWxMaW1pdCAtIGRlY2ltYWxQYXJ0Lmxlbmd0aDtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdmFsdWU6IHdpdGhEZWNpbWFsU3ltYm9sICsgYDBgLnJlcGVhdCh6ZXJvUGFkZGluZ1NpemUpLFxuICAgICAgICB9O1xuICAgIH07XG59XG5cbmZ1bmN0aW9uIGFkZERlY2ltYWxTeW1ib2xJZk5lZWRlZChcbiAgICB2YWx1ZTogc3RyaW5nLFxuICAgIGRlY2ltYWxTeW1ib2w6IFR1aURlY2ltYWxTeW1ib2wgPSBgLGAsXG4pOiBzdHJpbmcge1xuICAgIHJldHVybiAhdmFsdWUuaW5jbHVkZXMoZGVjaW1hbFN5bWJvbCkgPyB2YWx1ZSArIGRlY2ltYWxTeW1ib2wgOiB2YWx1ZTtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlU2FmYXJpQ2FyZXQoXG4gICAgcHJldmlvdXNWYWx1ZTogc3RyaW5nID0gYGAsXG4gICAgY3VycmVudDogc3RyaW5nLFxuICAgIHByZXZpb3VzQ2FyZXQ6IG51bWJlcixcbiAgICBkZWNpbWFsU3ltYm9sOiBzdHJpbmcgPSBgLGAsXG4pOiBudW1iZXIge1xuICAgIGNvbnN0IHRhaWxSZWdleCA9IG5ldyBSZWdFeHAoYCR7ZGVjaW1hbFN5bWJvbH0uK2ApO1xuICAgIGNvbnN0IHByZXZpb3VzV2l0aG91dFRhaWwgPSBwcmV2aW91c1ZhbHVlLnJlcGxhY2UodGFpbFJlZ2V4LCBgYCk7XG4gICAgY29uc3QgY3VycmVudFdpdGhvdXRUYWlsID0gY3VycmVudC5yZXBsYWNlKHRhaWxSZWdleCwgYGApO1xuXG4gICAgY29uc3QgcGFzdGVPckN1dE9wZXJhdGlvbiA9XG4gICAgICAgIE1hdGguYWJzKHByZXZpb3VzV2l0aG91dFRhaWwubGVuZ3RoIC0gY3VycmVudFdpdGhvdXRUYWlsLmxlbmd0aCkgPiAyO1xuXG4gICAgaWYgKHBhc3RlT3JDdXRPcGVyYXRpb24pIHtcbiAgICAgICAgcmV0dXJuIGN1cnJlbnQubGVuZ3RoO1xuICAgIH1cblxuICAgIGlmIChwcmV2aW91c1ZhbHVlLmxlbmd0aCA9PT0gY3VycmVudC5sZW5ndGgpIHtcbiAgICAgICAgaWYgKHByZXZpb3VzVmFsdWUuaW5kZXhPZihkZWNpbWFsU3ltYm9sKSA8PSBwcmV2aW91c0NhcmV0KSB7XG4gICAgICAgICAgICByZXR1cm4gY2FsY3VsYXRlQ2hhbmdlZFRhaWxJbmRleChwcmV2aW91c1ZhbHVlLCBjdXJyZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwcmV2aW91c1dpdGhvdXRUYWlsID09PSBjdXJyZW50V2l0aG91dFRhaWxcbiAgICAgICAgICAgID8gcHJldmlvdXNDYXJldCAtIDFcbiAgICAgICAgICAgIDogcHJldmlvdXNDYXJldCArIDE7XG4gICAgfVxuXG4gICAgaWYgKHByZXZpb3VzVmFsdWUubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgIH1cblxuICAgIGNvbnN0IGNoYW5nZUxlbmd0aCA9IGN1cnJlbnQubGVuZ3RoIC0gcHJldmlvdXNWYWx1ZS5sZW5ndGg7XG5cbiAgICByZXR1cm4gcHJldmlvdXNDYXJldCArIGNoYW5nZUxlbmd0aDtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlQ2hhbmdlZFRhaWxJbmRleChwcmV2aW91czogc3RyaW5nLCBjdXJyZW50OiBzdHJpbmcpOiBudW1iZXIge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY3VycmVudC5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAocHJldmlvdXNbaV0gIT09IGN1cnJlbnRbaV0pIHtcbiAgICAgICAgICAgIHJldHVybiBjdXJyZW50W2ldID09PSBgMGAgPyBpIDogaSArIDE7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gY3VycmVudC5sZW5ndGg7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUNhcmV0R2FwKFxuICAgIHByZXZpb3VzVmFsdWU6IHN0cmluZyA9IGBgLFxuICAgIGN1cnJlbnQ6IHN0cmluZyxcbiAgICB0aG91c2FuZFN5bWJvbDogc3RyaW5nLFxuKTogbnVtYmVyIHtcbiAgICBjb25zdCBwYXN0ZU9yQ3V0T3BlcmF0aW9uID0gTWF0aC5hYnMocHJldmlvdXNWYWx1ZS5sZW5ndGggLSBjdXJyZW50Lmxlbmd0aCkgPiAyO1xuXG4gICAgaWYgKHBhc3RlT3JDdXRPcGVyYXRpb24pIHtcbiAgICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgY29uc3Qgd2VyZVNwYWNlcyA9IHByZXZpb3VzVmFsdWUuc3BsaXQodGhvdXNhbmRTeW1ib2wpLmxlbmd0aDtcbiAgICBjb25zdCBub3dTcGFjZXMgPSBjdXJyZW50LnNwbGl0KHRob3VzYW5kU3ltYm9sKS5sZW5ndGg7XG5cbiAgICByZXR1cm4gbm93U3BhY2VzIC0gd2VyZVNwYWNlcztcbn1cbiJdfQ==