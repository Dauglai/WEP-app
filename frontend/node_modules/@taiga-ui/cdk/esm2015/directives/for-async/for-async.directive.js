import { Directive, Inject, Input, TemplateRef, ViewContainerRef, } from '@angular/core';
import { from, of, Subject } from 'rxjs';
import { concatMap, delay, takeUntil } from 'rxjs/operators';
import * as i0 from "@angular/core";
export class TuiForAsyncDirective {
    constructor(view, template) {
        this.view = view;
        this.template = template;
        this.destroy$ = new Subject();
        this.tuiForAsyncTimeout = 10;
    }
    ngOnChanges() {
        this.clearViewForOldNodes();
        this.createAsyncViewForNewNodes();
    }
    ngOnDestroy() {
        this.clearViewForOldNodes();
        this.destroy$.complete();
    }
    createAsyncViewForNewNodes() {
        from(this.iterableValues)
            .pipe(concatMap(entry => this.tuiForAsyncTimeout > 0
            ? of(entry).pipe(delay(this.tuiForAsyncTimeout))
            : of(entry)), takeUntil(this.destroy$))
            .subscribe(([index, item]) => this.createEmbeddedView(item, index));
    }
    get iterableValues() {
        var _a;
        return ((_a = this.tuiForAsyncOf) !== null && _a !== void 0 ? _a : []).entries();
    }
    createEmbeddedView(item, index) {
        this.view
            .createEmbeddedView(this.template, { $implicit: item, index }, index)
            .detectChanges();
    }
    clearViewForOldNodes() {
        this.destroy$.next();
        this.view.clear();
    }
}
TuiForAsyncDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: TuiForAsyncDirective, deps: [{ token: ViewContainerRef }, { token: TemplateRef }], target: i0.ɵɵFactoryTarget.Directive });
TuiForAsyncDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.2.17", type: TuiForAsyncDirective, selector: "[tuiForAsync][tuiForAsyncOf]", inputs: { tuiForAsyncOf: "tuiForAsyncOf", tuiForAsyncTimeout: "tuiForAsyncTimeout" }, usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.17", ngImport: i0, type: TuiForAsyncDirective, decorators: [{
            type: Directive,
            args: [{ selector: '[tuiForAsync][tuiForAsyncOf]' }]
        }], ctorParameters: function () { return [{ type: i0.ViewContainerRef, decorators: [{
                    type: Inject,
                    args: [ViewContainerRef]
                }] }, { type: i0.TemplateRef, decorators: [{
                    type: Inject,
                    args: [TemplateRef]
                }] }]; }, propDecorators: { tuiForAsyncOf: [{
                type: Input
            }], tuiForAsyncTimeout: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9yLWFzeW5jLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2Nkay9kaXJlY3RpdmVzL2Zvci1hc3luYy9mb3ItYXN5bmMuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDSCxTQUFTLEVBQ1QsTUFBTSxFQUNOLEtBQUssRUFHTCxXQUFXLEVBQ1gsZ0JBQWdCLEdBQ25CLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN2QyxPQUFPLEVBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQzs7QUFHM0QsTUFBTSxPQUFPLG9CQUFvQjtJQVc3QixZQUMrQyxJQUFzQixFQUMzQixRQUE4QjtRQUR6QixTQUFJLEdBQUosSUFBSSxDQUFrQjtRQUMzQixhQUFRLEdBQVIsUUFBUSxDQUFzQjtRQVZ2RCxhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQU1oRCx1QkFBa0IsR0FBRyxFQUFFLENBQUM7SUFLckIsQ0FBQztJQUVKLFdBQVc7UUFDUCxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztJQUN0QyxDQUFDO0lBRUQsV0FBVztRQUNQLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDN0IsQ0FBQztJQUVPLDBCQUEwQjtRQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQzthQUNwQixJQUFJLENBQ0QsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQ2QsSUFBSSxDQUFDLGtCQUFrQixHQUFHLENBQUM7WUFDdkIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQ2hELENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQ2xCLEVBQ0QsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FDM0I7YUFDQSxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQzVFLENBQUM7SUFFRCxJQUFZLGNBQWM7O1FBQ3RCLE9BQU8sQ0FBQyxNQUFBLElBQUksQ0FBQyxhQUFhLG1DQUFJLEVBQUUsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2hELENBQUM7SUFFTyxrQkFBa0IsQ0FBSSxJQUFPLEVBQUUsS0FBYTtRQUNoRCxJQUFJLENBQUMsSUFBSTthQUNKLGtCQUFrQixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQyxFQUFFLEtBQUssQ0FBQzthQUNsRSxhQUFhLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRU8sb0JBQW9CO1FBQ3hCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUN0QixDQUFDOztrSEFwRFEsb0JBQW9CLGtCQVlqQixnQkFBZ0IsYUFDaEIsV0FBVztzR0FiZCxvQkFBb0I7NEZBQXBCLG9CQUFvQjtrQkFEaEMsU0FBUzttQkFBQyxFQUFDLFFBQVEsRUFBRSw4QkFBOEIsRUFBQzs7MEJBYTVDLE1BQU07MkJBQUMsZ0JBQWdCOzswQkFDdkIsTUFBTTsyQkFBQyxXQUFXOzRDQVB2QixhQUFhO3NCQURaLEtBQUs7Z0JBSU4sa0JBQWtCO3NCQURqQixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBEaXJlY3RpdmUsXG4gICAgSW5qZWN0LFxuICAgIElucHV0LFxuICAgIE9uQ2hhbmdlcyxcbiAgICBPbkRlc3Ryb3ksXG4gICAgVGVtcGxhdGVSZWYsXG4gICAgVmlld0NvbnRhaW5lclJlZixcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge2Zyb20sIG9mLCBTdWJqZWN0fSBmcm9tICdyeGpzJztcbmltcG9ydCB7Y29uY2F0TWFwLCBkZWxheSwgdGFrZVVudGlsfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBEaXJlY3RpdmUoe3NlbGVjdG9yOiAnW3R1aUZvckFzeW5jXVt0dWlGb3JBc3luY09mXSd9KVxuZXhwb3J0IGNsYXNzIFR1aUZvckFzeW5jRGlyZWN0aXZlPFQgZXh0ZW5kcyByZWFkb25seSBhbnlbXT5cbiAgICBpbXBsZW1lbnRzIE9uQ2hhbmdlcywgT25EZXN0cm95XG57XG4gICAgcHJpdmF0ZSByZWFkb25seSBkZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgICBASW5wdXQoKVxuICAgIHR1aUZvckFzeW5jT2Y6IFQgfCBudWxsIHwgdW5kZWZpbmVkO1xuXG4gICAgQElucHV0KClcbiAgICB0dWlGb3JBc3luY1RpbWVvdXQgPSAxMDtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBASW5qZWN0KFZpZXdDb250YWluZXJSZWYpIHByaXZhdGUgcmVhZG9ubHkgdmlldzogVmlld0NvbnRhaW5lclJlZixcbiAgICAgICAgQEluamVjdChUZW1wbGF0ZVJlZikgcHJpdmF0ZSByZWFkb25seSB0ZW1wbGF0ZTogVGVtcGxhdGVSZWY8dW5rbm93bj4sXG4gICAgKSB7fVxuXG4gICAgbmdPbkNoYW5nZXMoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuY2xlYXJWaWV3Rm9yT2xkTm9kZXMoKTtcbiAgICAgICAgdGhpcy5jcmVhdGVBc3luY1ZpZXdGb3JOZXdOb2RlcygpO1xuICAgIH1cblxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgICAgICB0aGlzLmNsZWFyVmlld0Zvck9sZE5vZGVzKCk7XG4gICAgICAgIHRoaXMuZGVzdHJveSQuY29tcGxldGUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUFzeW5jVmlld0Zvck5ld05vZGVzKCk6IHZvaWQge1xuICAgICAgICBmcm9tKHRoaXMuaXRlcmFibGVWYWx1ZXMpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBjb25jYXRNYXAoZW50cnkgPT5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy50dWlGb3JBc3luY1RpbWVvdXQgPiAwXG4gICAgICAgICAgICAgICAgICAgICAgICA/IG9mKGVudHJ5KS5waXBlKGRlbGF5KHRoaXMudHVpRm9yQXN5bmNUaW1lb3V0KSlcbiAgICAgICAgICAgICAgICAgICAgICAgIDogb2YoZW50cnkpLFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveSQpLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgoW2luZGV4LCBpdGVtXSkgPT4gdGhpcy5jcmVhdGVFbWJlZGRlZFZpZXcoaXRlbSwgaW5kZXgpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldCBpdGVyYWJsZVZhbHVlcygpOiBJdGVyYWJsZUl0ZXJhdG9yPFtudW1iZXIsIFRdPiB7XG4gICAgICAgIHJldHVybiAodGhpcy50dWlGb3JBc3luY09mID8/IFtdKS5lbnRyaWVzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVFbWJlZGRlZFZpZXc8VD4oaXRlbTogVCwgaW5kZXg6IG51bWJlcik6IHZvaWQge1xuICAgICAgICB0aGlzLnZpZXdcbiAgICAgICAgICAgIC5jcmVhdGVFbWJlZGRlZFZpZXcodGhpcy50ZW1wbGF0ZSwgeyRpbXBsaWNpdDogaXRlbSwgaW5kZXh9LCBpbmRleClcbiAgICAgICAgICAgIC5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjbGVhclZpZXdGb3JPbGROb2RlcygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XG4gICAgICAgIHRoaXMudmlldy5jbGVhcigpO1xuICAgIH1cbn1cbiJdfQ==