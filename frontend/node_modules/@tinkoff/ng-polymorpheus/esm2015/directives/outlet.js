import { ChangeDetectorRef, ComponentFactoryResolver, Directive, TemplateRef, } from '@angular/core';
import { PolymorpheusComponent } from '../classes/component';
import { PolymorpheusContext } from '../classes/context';
import { PolymorpheusTemplate } from './template';
import * as i0 from "@angular/core";
export class PolymorpheusOutletDirective {
    constructor(vcr, i, t) {
        this.vcr = vcr;
        this.i = i;
        this.t = t;
        this.content = '';
    }
    get template() {
        if (isDirective(this.content)) {
            return this.content.template;
        }
        return this.content instanceof TemplateRef ? this.content : this.t;
    }
    ngOnChanges({ content }) {
        var _a;
        const context = this.getContext();
        if (this.v) {
            this.v.context = context;
        }
        (_a = this.c) === null || _a === void 0 ? void 0 : _a.injector.get(ChangeDetectorRef).markForCheck();
        if (!content) {
            return;
        }
        this.vcr.clear();
        if (isComponent(this.content)) {
            this.process(this.content);
        }
        else if (
        // tslint:disable-next-line:triple-equals
        (context instanceof PolymorpheusContext && context.$implicit) != null) {
            this.v = this.vcr.createEmbeddedView(this.template, context);
        }
    }
    ngDoCheck() {
        if (isDirective(this.content)) {
            this.content.check();
        }
    }
    static ngTemplateContextGuard(_dir, _ctx) {
        return true;
    }
    getContext() {
        if (isTemplate(this.content) || isComponent(this.content)) {
            return this.context;
        }
        return new PolymorpheusContext(typeof this.content === 'function'
            ? this.content(this.context)
            : this.content);
    }
    process(content) {
        const injector = content.createInjector(this.i, this.context &&
            new Proxy(this.context, {
                get: (_, key) => { var _a; return (_a = this.context) === null || _a === void 0 ? void 0 : _a[key]; },
            }));
        this.c = this.vcr.createComponent(injector
            .get(ComponentFactoryResolver)
            .resolveComponentFactory(content.component), 0, injector);
    }
}
/** @nocollapse */ PolymorpheusOutletDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.0.0", ngImport: i0, type: PolymorpheusOutletDirective, deps: [{ token: i0.ViewContainerRef }, { token: i0.Injector }, { token: i0.TemplateRef }], target: i0.ɵɵFactoryTarget.Directive });
/** @nocollapse */ PolymorpheusOutletDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.0.0", type: PolymorpheusOutletDirective, selector: "[polymorpheusOutlet]", inputs: { content: ["polymorpheusOutlet", "content"], context: ["polymorpheusOutletContext", "context"] }, usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.0.0", ngImport: i0, type: PolymorpheusOutletDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: '[polymorpheusOutlet]',
                    inputs: ['content: polymorpheusOutlet', 'context: polymorpheusOutletContext'],
                }]
        }], ctorParameters: function () { return [{ type: i0.ViewContainerRef }, { type: i0.Injector }, { type: i0.TemplateRef }]; } });
function isDirective(content) {
    return content instanceof PolymorpheusTemplate;
}
function isComponent(content) {
    return content instanceof PolymorpheusComponent;
}
function isTemplate(content) {
    return isDirective(content) || content instanceof TemplateRef;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3V0bGV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctcG9seW1vcnBoZXVzL3NyYy9kaXJlY3RpdmVzL291dGxldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0gsaUJBQWlCLEVBQ2pCLHdCQUF3QixFQUV4QixTQUFTLEVBTVQsV0FBVyxHQUVkLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxxQkFBcUIsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQzNELE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLG9CQUFvQixDQUFDO0FBR3ZELE9BQU8sRUFBQyxvQkFBb0IsRUFBQyxNQUFNLFlBQVksQ0FBQzs7QUFNaEQsTUFBTSxPQUFPLDJCQUEyQjtJQU9wQyxZQUNxQixHQUFxQixFQUNyQixDQUFXLEVBQ1gsQ0FBMEQ7UUFGMUQsUUFBRyxHQUFILEdBQUcsQ0FBa0I7UUFDckIsTUFBQyxHQUFELENBQUMsQ0FBVTtRQUNYLE1BQUMsR0FBRCxDQUFDLENBQXlEO1FBTi9FLFlBQU8sR0FBMkIsRUFBRSxDQUFDO0lBT2xDLENBQUM7SUFFSixJQUFZLFFBQVE7UUFDaEIsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzNCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUM7U0FDaEM7UUFFRCxPQUFPLElBQUksQ0FBQyxPQUFPLFlBQVksV0FBVyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7SUFFRCxXQUFXLENBQUMsRUFBQyxPQUFPLEVBQWdCOztRQUNoQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFFbEMsSUFBSSxJQUFJLENBQUMsQ0FBQyxFQUFFO1lBQ1IsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLEdBQUcs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ZURldGVjdG9yUmVmLFxyXG4gICAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gICAgQ29tcG9uZW50UmVmLFxyXG4gICAgRGlyZWN0aXZlLFxyXG4gICAgRG9DaGVjayxcclxuICAgIEVtYmVkZGVkVmlld1JlZixcclxuICAgIEluamVjdG9yLFxyXG4gICAgT25DaGFuZ2VzLFxyXG4gICAgU2ltcGxlQ2hhbmdlcyxcclxuICAgIFRlbXBsYXRlUmVmLFxyXG4gICAgVmlld0NvbnRhaW5lclJlZixcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtQb2x5bW9ycGhldXNDb21wb25lbnR9IGZyb20gJy4uL2NsYXNzZXMvY29tcG9uZW50JztcclxuaW1wb3J0IHtQb2x5bW9ycGhldXNDb250ZXh0fSBmcm9tICcuLi9jbGFzc2VzL2NvbnRleHQnO1xyXG5pbXBvcnQge1BvbHltb3JwaGV1c0NvbnRlbnR9IGZyb20gJy4uL3R5cGVzL2NvbnRlbnQnO1xyXG5pbXBvcnQge1BvbHltb3JwaGV1c1ByaW1pdGl2ZX0gZnJvbSAnLi4vdHlwZXMvcHJpbWl0aXZlJztcclxuaW1wb3J0IHtQb2x5bW9ycGhldXNUZW1wbGF0ZX0gZnJvbSAnLi90ZW1wbGF0ZSc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiAnW3BvbHltb3JwaGV1c091dGxldF0nLFxyXG4gICAgaW5wdXRzOiBbJ2NvbnRlbnQ6IHBvbHltb3JwaGV1c091dGxldCcsICdjb250ZXh0OiBwb2x5bW9ycGhldXNPdXRsZXRDb250ZXh0J10sXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBQb2x5bW9ycGhldXNPdXRsZXREaXJlY3RpdmU8Qz4gaW1wbGVtZW50cyBPbkNoYW5nZXMsIERvQ2hlY2sge1xyXG4gICAgcHJpdmF0ZSB2PzogRW1iZWRkZWRWaWV3UmVmPHVua25vd24+O1xyXG4gICAgcHJpdmF0ZSBjPzogQ29tcG9uZW50UmVmPHVua25vd24+O1xyXG5cclxuICAgIGNvbnRlbnQ6IFBvbHltb3JwaGV1c0NvbnRlbnQ8Qz4gPSAnJztcclxuICAgIGNvbnRleHQ/OiBDO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgdmNyOiBWaWV3Q29udGFpbmVyUmVmLFxyXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgaTogSW5qZWN0b3IsXHJcbiAgICAgICAgcHJpdmF0ZSByZWFkb25seSB0OiBUZW1wbGF0ZVJlZjxQb2x5bW9ycGhldXNDb250ZXh0PFBvbHltb3JwaGV1c1ByaW1pdGl2ZT4+LFxyXG4gICAgKSB7fVxyXG5cclxuICAgIHByaXZhdGUgZ2V0IHRlbXBsYXRlKCk6IFRlbXBsYXRlUmVmPHVua25vd24+IHtcclxuICAgICAgICBpZiAoaXNEaXJlY3RpdmUodGhpcy5jb250ZW50KSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb250ZW50LnRlbXBsYXRlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY29udGVudCBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmID8gdGhpcy5jb250ZW50IDogdGhpcy50O1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25DaGFuZ2VzKHtjb250ZW50fTogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSB0aGlzLmdldENvbnRleHQoKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMudikge1xyXG4gICAgICAgICAgICB0aGlzLnYuY29udGV4dCA9IGNvbnRleHQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmM/LmluamVjdG9yLmdldChDaGFuZ2VEZXRlY3RvclJlZikubWFya0ZvckNoZWNrKCk7XHJcblxyXG4gICAgICAgIGlmICghY29udGVudCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnZjci5jbGVhcigpO1xyXG5cclxuICAgICAgICBpZiAoaXNDb21wb25lbnQodGhpcy5jb250ZW50KSkge1xyXG4gICAgICAgICAgICB0aGlzLnByb2Nlc3ModGhpcy5jb250ZW50KTtcclxuICAgICAgICB9IGVsc2UgaWYgKFxyXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dHJpcGxlLWVxdWFsc1xyXG4gICAgICAgICAgICAoY29udGV4dCBpbnN0YW5jZW9mIFBvbHltb3JwaGV1c0NvbnRleHQgJiYgY29udGV4dC4kaW1wbGljaXQpICE9IG51bGxcclxuICAgICAgICApIHtcclxuICAgICAgICAgICAgdGhpcy52ID0gdGhpcy52Y3IuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMudGVtcGxhdGUsIGNvbnRleHQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ0RvQ2hlY2soKSB7XHJcbiAgICAgICAgaWYgKGlzRGlyZWN0aXZlKHRoaXMuY29udGVudCkpIHtcclxuICAgICAgICAgICAgdGhpcy5jb250ZW50LmNoZWNrKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBuZ1RlbXBsYXRlQ29udGV4dEd1YXJkPFQ+KFxyXG4gICAgICAgIF9kaXI6IFBvbHltb3JwaGV1c091dGxldERpcmVjdGl2ZTxUPixcclxuICAgICAgICBfY3R4OiBhbnksXHJcbiAgICApOiBfY3R4IGlzIFBvbHltb3JwaGV1c0NvbnRleHQ8c3RyaW5nPiB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRDb250ZXh0KCk6IHVua25vd24ge1xyXG4gICAgICAgIGlmIChpc1RlbXBsYXRlKHRoaXMuY29udGVudCkgfHwgaXNDb21wb25lbnQodGhpcy5jb250ZW50KSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jb250ZXh0O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIG5ldyBQb2x5bW9ycGhldXNDb250ZXh0KFxyXG4gICAgICAgICAgICB0eXBlb2YgdGhpcy5jb250ZW50ID09PSAnZnVuY3Rpb24nXHJcbiAgICAgICAgICAgICAgICA/IHRoaXMuY29udGVudCh0aGlzLmNvbnRleHQhKVxyXG4gICAgICAgICAgICAgICAgOiB0aGlzLmNvbnRlbnQsXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHByb2Nlc3MoY29udGVudDogUG9seW1vcnBoZXVzQ29tcG9uZW50PHVua25vd24+KTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgaW5qZWN0b3IgPSBjb250ZW50LmNyZWF0ZUluamVjdG9yKFxyXG4gICAgICAgICAgICB0aGlzLmksXHJcbiAgICAgICAgICAgIHRoaXMuY29udGV4dCAmJlxyXG4gICAgICAgICAgICAgICAgKChuZXcgUHJveHkoKHRoaXMuY29udGV4dCBhcyB1bmtub3duKSBhcyBvYmplY3QsIHtcclxuICAgICAgICAgICAgICAgICAgICBnZXQ6IChfLCBrZXkpID0+IHRoaXMuY29udGV4dD8uW2tleSBhcyBrZXlvZiBDXSxcclxuICAgICAgICAgICAgICAgIH0pIGFzIHVua25vd24pIGFzIEMpLFxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIHRoaXMuYyA9IHRoaXMudmNyLmNyZWF0ZUNvbXBvbmVudChcclxuICAgICAgICAgICAgaW5qZWN0b3JcclxuICAgICAgICAgICAgICAgIC5nZXQoQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKVxyXG4gICAgICAgICAgICAgICAgLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbnRlbnQuY29tcG9uZW50KSxcclxuICAgICAgICAgICAgMCxcclxuICAgICAgICAgICAgaW5qZWN0b3IsXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaXNEaXJlY3RpdmU8Qz4oXHJcbiAgICBjb250ZW50OiBQb2x5bW9ycGhldXNDb250ZW50PEM+LFxyXG4pOiBjb250ZW50IGlzIFBvbHltb3JwaGV1c1RlbXBsYXRlPEM+IHtcclxuICAgIHJldHVybiBjb250ZW50IGluc3RhbmNlb2YgUG9seW1vcnBoZXVzVGVtcGxhdGU7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzQ29tcG9uZW50PEM+KFxyXG4gICAgY29udGVudDogUG9seW1vcnBoZXVzQ29udGVudDxDPixcclxuKTogY29udGVudCBpcyBQb2x5bW9ycGhldXNDb21wb25lbnQ8YW55LCBDPiB7XHJcbiAgICByZXR1cm4gY29udGVudCBpbnN0YW5jZW9mIFBvbHltb3JwaGV1c0NvbXBvbmVudDtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNUZW1wbGF0ZTxDPihcclxuICAgIGNvbnRlbnQ6IFBvbHltb3JwaGV1c0NvbnRlbnQ8Qz4sXHJcbik6IGNvbnRlbnQgaXMgUG9seW1vcnBoZXVzVGVtcGxhdGU8Qz4gfCBUZW1wbGF0ZVJlZjxDPiB7XHJcbiAgICByZXR1cm4gaXNEaXJlY3RpdmUoY29udGVudCkgfHwgY29udGVudCBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmO1xyXG59XHJcbiJdfQ==